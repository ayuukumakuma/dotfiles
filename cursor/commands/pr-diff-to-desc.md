# PR Description 更新（差分から生成）

## 概要
Pull Request の Git 差分を分析し、既存の Description に「## 対応内容」と「## 受け入れ条件」セクションを自動生成して追記します。既存の Description は保持され、該当セクションのみが更新されます。

**重要**: Description は日本語で生成されます。

## 手順

1. **PR 情報の取得**
   - `gh pr view <PR番号>` で以下の情報を取得：
     - PR タイトル
     - ベースブランチ（マージ先ブランチ）
     - HEAD ブランチ
     - 既存の Description 本文
   - PR が存在しない場合はエラーを表示して終了
   - **比較元ブランチの決定**：
     - 第2引数が指定されている場合：
       - 第2引数がPR番号の場合：`gh pr view <第2引数>` でそのPRのマージ先ブランチを取得し、それを比較元とする
       - 第2引数がブランチ名の場合：そのブランチを比較元とする
     - 第2引数が省略されている場合：`main` を比較元とする

2. **Git 差分の取得**
   - 決定した比較元ブランチ（`<base>`）とPRのHEADブランチ（`<HEAD>`）を使用
   - `git diff <base>...<HEAD>` で PR 全体の差分を取得
   - `git log <base>..<HEAD> --format="%H %s"` でコミットハッシュとメッセージを取得
   - `gh repo view --json url` でリポジトリURLを取得し、コミットリンクを生成（形式: `https://github.com/owner/repo/commit/<hash>`）
   - 変更されたファイルの一覧を取得

3. **対応内容の生成**
   - 差分を分析して変更内容を日本語で要約
   - 以下の観点で整理：
     - 変更されたファイル・モジュール
     - 追加された機能（feat）
     - 修正されたバグ（fix）
     - リファクタリング（refactor）
     - ドキュメント更新（docs）
     - その他の変更（style, test, chore 等）
   - 箇条書き形式で簡潔に記述
   - コミット一覧を「### コミット」サブセクションとして追記
     - 各コミットを `[コミットメッセージ](https://github.com/owner/repo/commit/<hash>)` 形式のリンクで記載

4. **受け入れ条件の生成**
   - 変更内容から推測される確認事項をチェックリスト形式（`- [ ]`）で生成
   - 以下の項目を含める：
     - **実装内容の確認**: 各機能が正しく実装されているか
     - **テスト項目**: 単体テスト、統合テスト、動作確認など
     - **ドキュメント**: README やコメントの更新
     - **互換性**: 既存機能への影響や破壊的変更の有無
     - **パフォーマンス**: 必要に応じてパフォーマンスへの影響
   - **生成後、ユーザーに内容を提示し、修正・追加の確認を求める**

5. **既存 Description の処理**
   - 既存 Description に「## 対応内容」または「## 受け入れ条件」セクションが存在するか確認
   - 存在する場合：該当セクションの内容を新しい内容で置き換え
   - 存在しない場合：既存 Description の末尾に新しいセクションを追加
   - その他のセクション（## 概要、## 背景、## 関連 Issue など）はそのまま保持

6. **Description のプレビュー表示**
   - 生成された Description 全体をマークダウン形式で表示
   - 既存部分と新規追加部分を明確に示す

7. **ユーザー承認フロー**
   - **Description の内容が正しいか確認を求める**（例：「この Description で更新してよろしいですか？」）
   - ユーザーが承認するまで `gh pr edit` を実行しない
   - ユーザーが修正を希望する場合は、フィードバックに基づいて Description を修正し、再度確認を求める
   - ユーザーが承認した場合のみ、`gh pr edit <PR番号> --body "Description全体"` を実行する

## Description フォーマット例

### 基本的な形式

```markdown
## 対応内容

- Fish shell の設定を更新
  - git status の新しい略語 `gst` を追加
  - tide プロンプトのカラースキームを変更
- Nix パッケージを更新
  - `ripgrep` を最新バージョンに更新
  - `bat` を依存関係に追加

### コミット
- [git status の略語 gst を追加](https://github.com/user/repo/commit/abc1234...)
- [tide プロンプトのカラースキームを変更](https://github.com/user/repo/commit/def5678...)
- [ripgrep を最新バージョンに更新](https://github.com/user/repo/commit/ghi9012...)

## 受け入れ条件

- [ ] Fish shell で `gst` コマンドが正しく動作する
- [ ] tide プロンプトが新しいカラースキームで表示される
- [ ] ripgrep と bat が正常にインストールされる
- [ ] 既存の Fish 設定が破壊されていない
- [ ] nix build が成功する
```

### 既存 Description を保持した例

```markdown
## 概要
Fish shell と Nix パッケージの設定を改善します。

## 背景
日常的に使用するコマンドの効率化とツールの最新化を目的としています。

## 対応内容

- Fish shell の設定を更新
  - git status の新しい略語 `gst` を追加
  - tide プロンプトのカラースキームを変更
- Nix パッケージを更新
  - `ripgrep` を最新バージョンに更新
  - `bat` を依存関係に追加

### コミット
- [git status の略語 gst を追加](https://github.com/user/repo/commit/abc1234...)
- [tide プロンプトのカラースキームを変更](https://github.com/user/repo/commit/def5678...)
- [ripgrep を最新バージョンに更新](https://github.com/user/repo/commit/ghi9012...)

## 受け入れ条件

- [ ] Fish shell で `gst` コマンドが正しく動作する
- [ ] tide プロンプトが新しいカラースキームで表示される
- [ ] ripgrep と bat が正常にインストールされる
- [ ] 既存の Fish 設定が破壊されていない
- [ ] nix build が成功する

## 関連 Issue
- #123
```

### 複数のカテゴリにまたがる変更の例

```markdown
## 対応内容

### 新機能（feat）
- Claude Code の Slack 通知機能を追加
- 1Password CLI との統合スクリプトを実装

### バグ修正（fix）
- Git 設定更新スクリプトの実行権限エラーを修正
- Fish shell の環境変数読み込みタイミングを修正

### ドキュメント（docs）
- README にセットアップ手順を追加
- CLAUDE.md にセキュリティ設定の説明を追加

## 受け入れ条件

- [ ] Slack 通知が正しく送信される
- [ ] 1Password CLI スクリプトが正常に実行できる
- [ ] Git 設定更新スクリプトが実行権限エラーなく動作する
- [ ] Fish shell で環境変数が正しく読み込まれる
- [ ] README の手順に従ってセットアップできる
- [ ] CLAUDE.md のセキュリティ設定が正確である
```

## チェックリスト

- [ ] PR 番号を正しく指定した
- [ ] PR 情報を取得し、存在を確認した
- [ ] Git 差分を取得した
- [ ] 差分を分析して対応内容を日本語で生成した
- [ ] 受け入れ条件をチェックリスト形式で生成した
- [ ] 受け入れ条件の内容をユーザーに確認し、フィードバックを反映した
- [ ] 既存 Description を保持しつつ、該当セクションを更新した
- [ ] 生成された Description をユーザーに提示した
- [ ] ユーザーの承認を得た
- [ ] 承認後に `gh pr edit` を実行した

## 実行

以下のコマンドで PR Description を更新してください：

```
/pr-diff-to-desc <PR番号> [比較元ブランチまたはPR番号]
```

- `<PR番号>`: 更新対象のPR番号（必須）
- `[比較元ブランチまたはPR番号]`: 比較元を指定（省略可、省略時は `main` と比較）
  - ブランチ名を指定した場合：そのブランチとの差分を取得
  - PR番号を指定した場合：そのPRのマージ先ブランチとの差分を取得

### 実行フロー

1. **PR 情報と差分の取得**
   - `gh pr view <PR番号>` で PR 情報を確認
   - **比較元ブランチの決定**：
     - 第2引数が指定されている場合：
       - 第2引数がPR番号の場合：`gh pr view <第2引数>` でそのPRのマージ先ブランチを取得し、それを比較元（`<base>`）とする
       - 第2引数がブランチ名の場合：そのブランチを比較元（`<base>`）とする
     - 第2引数が省略されている場合：`main` を比較元（`<base>`）とする
   - `git diff <base>...<HEAD>` で変更内容を取得（`<HEAD>` は対象PRのHEADブランチ）
   - `git log <base>..<HEAD> --format="%H %s"` でコミットハッシュとメッセージを取得
   - `gh repo view --json url` でリポジトリURLを取得し、コミットリンク生成に使用

2. **対応内容の生成**
   - 差分を分析して変更内容を日本語で要約
   - カテゴリごとに分類（feat, fix, refactor, docs など）
   - 箇条書き形式で整理
   - コミット一覧を「### コミット」サブセクションとして生成
     - 取得したコミットハッシュとメッセージから、GitHubリンク付きのリストを作成
     - リンク形式: `[コミットメッセージ](https://github.com/owner/repo/commit/<hash>)`

3. **受け入れ条件の生成と確認**
   - 変更内容から推測される確認事項をチェックリスト形式で生成
   - **生成した受け入れ条件をユーザーに提示**
   - **ユーザーに追加・修正の確認を求める**（例：「この受け入れ条件で問題ありませんか？追加・修正したい項目はありますか？」）
   - フィードバックがあれば反映して再生成

4. **既存 Description の処理**
   - 既存 Description を取得
   - 「## 対応内容」「## 受け入れ条件」セクションの有無を確認
   - 該当セクションを更新または追加
   - その他のセクションは保持

5. **Description のプレビューと承認**
   - **更新後の Description 全体をマークダウン形式で表示**
   - コードブロックで返す場合は、開閉ともに三連バッククォート（例: ```` ```markdown ... ``` ````）を必ず付ける
   - **ユーザーに確認を求める**（例：「この Description で PR を更新してよろしいですか？」）
   - ユーザーが承認した場合のみ次のステップへ
   - 修正を希望する場合は、フィードバックに基づいて Description を修正し、再度確認を求める

6. **PR の更新**
   - ユーザーが承認した場合のみ `gh pr edit <PR番号> --body "Description全体"` を実行
   - 更新完了メッセージを表示

### 注意事項

- Markdown のコードブロックは **必ず** 三連バッククォートで開閉すること（例: ```` ```markdown ... ``` ````）。閉じ忘れ防止のため末尾のバッククォートも必ず入れる
- **必ずユーザーの承認を得てから PR を更新すること**
- ユーザーが拒否または修正を希望した場合は、承認を得るまで更新を実行しないこと
- Description のプレビューを明確に表示し、ユーザーが内容を確認できるようにすること
- 受け入れ条件の生成時も、必ずユーザーに確認を求めること
- 既存 Description を誤って削除しないよう注意すること
- Git 差分が非常に大きい場合は、要約の精度を優先すること
- `gh` コマンドが正しくインストールされ、認証されていることを前提とする

### 実行例

#### 例1: 単一の機能追加（mainと比較）

```
/pr-diff-to-desc 123
```

#### 例2: 特定のブランチと比較

```
/pr-diff-to-desc 123 develop
```

#### 例3: 別のPRのマージ先ブランチと比較

```
/pr-diff-to-desc 123 45
```
（PR #45 のマージ先ブランチとの差分を取得）

#### 例4: 追加の指示を含める

```
/pr-diff-to-desc 456 develop セキュリティ関連の変更を重点的に説明してください
```

#### 例5: 特定のセクションのみ更新

```
/pr-diff-to-desc 789 main 受け入れ条件のみを更新してください
```
